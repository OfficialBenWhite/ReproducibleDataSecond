---
title: Analysis of historic data to identify areas in which resources should be prioritised
  in the event of a storm.
author: "OfficialBenWhite"
date: "20 July 2015"
output: html_document
keep_md: true
---

Synposis goes here.

##Data Processing

Load packages
```{r}
library(ggplot2)
library(lubridate)
library(dplyr)
```

Next download the storm data from the NOAA Storm Database

Set the working directory, the file variable and the url.

```{r}
library(ggplot2)
library(lubridate)
library(dplyr)
setwd("/Users/bw/RCourse/C5W3")
file <- "StormData.csv.bz2"
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
```

Checks if file is downloaded otherwise download it.

```{r}
if(!file.exists(file)){   
    download.file(url,file, method="curl")
}
```

Use read.csv() to read the file into memory. This section is cached because it is computionally expensive. 

```{r, cache=TRUE}
stormData <- read.csv(file)
#stormData0 <- read.table(file, sep = ",", na.strings = " ", header = TRUE)
```

As per this link: 
https://www.ncdc.noaa.gov/stormevents/details.jsp
Filter out any event that happened before 1996 because not all variables were recorded before then

```{r}
stormData$date<- mdy_hms(stormData$BGN_DATE)
stormData2 <- subset(stormData, stormData$date > mdy("12/31/1995"))
```

Combine the PROPDMG and CROPDMG columns with their multipliers.
Page 12 of https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf
states that:
" Alphabetical characters used to signify magnitude
include “K” for thousands, “M” for millions, and “B” for billions. "

Looking at the number of each value it makes sense to remove anything else
```{r}
table(stormData2$PROPDMGEXP)
```

Therefore subsetting out everything that is not K , M, B or blank in the exponential columns.

Subsetting on the good values and then transforming the variables to their exponents

```{r}
indx  <- stormData2$CROPDMGEXP %in% c("K","M","B"," ", "")
indx2 <- stormData2$PROPDMGEXP  %in% c("K","M","B"," ", "")
importantColumns <- c("date", "EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP", "CROPDMG", "CROPDMGEXP")
df <- stormData2[(indx && indx2), importantColumns]
```


Translate the exponents into numbers.w
```{r}
df$cropdmgexpn[df$CROPDMGEXP == "K"] <- 1000
df$cropdmgexpn[df$CROPDMGEXP == "M"] <- 1e+06
df$cropdmgexpn[df$CROPDMGEXP == "B"] <- 1e+09
df$propdmgexpn[df$PROPDMGEXP == "K"] <- 1000
df$propdmgexpn[df$PROPDMGEXP == "M"] <- 1e+06
df$propdmgexpn[df$PROPDMGEXP == "B"] <- 1e+09
```

Create new columns for crop damage and property damage with exponents included
```{r}
df$cropdmg = df$cropdmgexpn * df$CROPDMG
df$propdmg = df$propdmgexpn * df$PROPDMG
```

Now group by EVTYPE and sum the data.

```{r}
grp <- group_by(df, EVTYPE)
sumdf <- summarise(grp, fatalities = sum(FATALITIES, na.rm = TRUE), injuries = sum(INJURIES, na.rm = TRUE), cropdamage = sum(cropdmg, na.rm = TRUE), propdamage = sum(propdmg, na.rm = TRUE), count = n())

sumdf <- df %>%
    group_by(EVTYPE)  %>%
    summarise(fatalities = sum(FATALITIES, na.rm = TRUE), 
              injuries = sum(INJURIES, na.rm = TRUE), 
              cropdamage = sum(cropdmg, na.rm = TRUE), 
              propdamage = sum(propdmg, na.rm = TRUE), 
              count = n())  %>%
    mutate(rel.freq = paste0(round(100 * count/sum(count), 0), "%"))
```

Lets see the most fatal event type
```{r, results='asis'}
knitr::kable(head(arrange(sumdf, desc(fatalities)) n = 15))
```
